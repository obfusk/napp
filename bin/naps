#!/bin/bash

# --                                                            # {{{1
#
# File        : naps
# Maintainer  : Felix C. Stegerman <flx@obfusk.net>
# Date        : 2012-08-11
#
# Copyright   : Copyright (C) 2012  Felix C. Stegerman
# Licence     : GPLv2
#
# --                                                            # }}}1

   usage='naps [ <command> [<app(s)>] | help ]'
commands='update|start|stop|restart|status'

function die () { echo "${2:-error}: $1" >&2; exit 1; }

rc="${NAPRC:-/etc/naprc}"
source "$rc" || die 'failed to load naprc'

# --

apps=()
shopt -s nullglob
for x in "$NAP_APP_DIR"/*; do [ -e "$x/app" ] && apps+=( "$x" ); done
shopt -u nullglob

# --

if [ "$1" == help ]; then
  sed 's!^    !!g' <<__END
    Usage     : $usage
    Commands  : list, ${commands//\|/, }
__END
elif [ "$#" -eq 0 ]; then
  die "TODO"
else
  cmd="$1"; shift

  if [ "$cmd" == list ]; then
    for x in "${apps[@]}"; do echo "$x"; done
  elif [[ "$cmd" =~ ^($commands)$ ]]; then
    if [ "$#" -eq 0 ]; then as=( "${apps[@]}" ); else as=( "$@" ); fi
    for x in "${as[@]}"; do
      nap "$cmd" "$x"
    done
  else
    echo "error: unknown command \`$cmd'" >&2
    die "$usage" usage
  fi
fi

# --

# vim: set tw=70 sw=2 sts=2 et fdm=marker :
